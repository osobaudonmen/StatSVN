name: Build and Release JAR

on:
  push:
    branches:
      - main

jobs:
  build-and-release:
    name: Build and attach JAR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '21'

      - name: Ensure build script is executable
        run: chmod +x ./build.sh

      - name: Build project
        run: |
          ./build.sh

      - name: Verify built JAR exists
        run: |
          if [ ! -f build/dist/statsvn.jar ]; then
            echo "ERROR: build/dist/statsvn.jar not found";
            ls -la build || true;
            exit 1;
          fi

      - name: Prepare release artifacts (zip containing JAR, README.md, LICENSE)
        id: prepare
        run: |
          set -e
          mkdir -p dist
          ZIP_NAME="statsvn_${{ github.run_number }}.zip"
          # Copy jar and docs into dist
          cp build/dist/statsvn.jar dist/statsvn.jar
          cp README.md dist/README.md || true
          cp LICENSE dist/LICENSE || true
          cd dist
          zip -r "$ZIP_NAME" statsvn.jar README.md LICENSE || true
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Generate release body
        id: release_body
        run: |
          set -e
          # Attempt to list files added in this push (fallback gracefully)
          added_files=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || true)
          
          # Build the release body
          echo "RELEASE_BODY<<EOF" >> $GITHUB_OUTPUT
          echo "## Build Information" >> $GITHUB_OUTPUT
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "- **Build Date**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
          echo "- **Run number**: ${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Artifacts" >> $GITHUB_OUTPUT
          echo "- ZIP: \`${{ steps.prepare.outputs.zip_name }}\` (contains statsvn.jar, README.md, LICENSE)" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Changed files in this push" >> $GITHUB_OUTPUT
          
          if [ -n "$added_files" ]; then
            echo "$added_files" >> $GITHUB_OUTPUT
          else
            echo "- (no new files detected)" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create and push tag
        id: create_tag
        run: |
          TAG="build-${{ github.run_id }}"
          echo "Creating tag: $TAG"
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          git tag -a "$TAG" -m "Automated build $TAG - $GITHUB_SHA"
          git push origin "$TAG"
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT

      - name: Create release and upload ZIP
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.create_tag.outputs.tag_name }}
          name: "Release #${{ github.run_number }}"
          body: ${{ steps.release_body.outputs.RELEASE_BODY }}
          files: |
            dist/${{ steps.prepare.outputs.zip_name }}

      - name: Cleanup old releases (keep latest 5)
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Installing gh CLI..."
          sudo apt-get update && sudo apt-get install -y gh jq || true

          echo "Cleaning up old releases (keeping latest 5)..."
          # List releases that start with 'build-', sorted by createdAt descending, skip first 5
          releases=$(gh release list --limit 100 --json tagName,createdAt --jq 'map(select(.tagName | startswith("build-"))) | sort_by(.createdAt) | reverse | .[5:] | map(.tagName) | .[]')

          for tag in $releases; do
            if [ -n "$tag" ] && [ "$tag" != "${{ steps.create_tag.outputs.tag_name }}" ]; then
              echo "Deleting release: $tag"
              gh release delete "$tag" --yes --cleanup-tag || echo "Failed to delete $tag (might not exist)"
            fi
          done
